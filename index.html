<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pannellum 360 Viewer</title>

  <!-- Pannellum -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #000; color: #eaeaea; font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #panorama { width: 100%; height: 100%; pointer-events: auto; touch-action: manipulation; }
    #overlay {
      position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.78); z-index: 10; text-align: center; padding: 24px;
    }
    #list {
      position: absolute; inset: 0; overflow: auto; display: none; padding: 20px;
    }
    #list h2 { margin: 0 0 10px; }
    #list a { color: #7cc6ff; text-decoration: none; }
    #list a:hover { text-decoration: underline; }
    code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div id="panorama"></div>
  <div id="overlay"></div>
  <div id="list"></div>

  <script>
    const manifestUrl = 'manifest.json';

    // --- Query helpers ---
    const Q = new URLSearchParams(location.search);
    const qs = (k, d=null) => Q.has(k) ? Q.get(k) : d;
    const num = (k, d) => (Q.has(k) && Number.isFinite(Number(Q.get(k)))) ? Number(Q.get(k)) : d;

    // --- Dropbox share -> raw URL ---
    function toDropboxRaw(url) {
      try {
        const u = new URL(url);
        if (!/dropbox\.com$/.test(u.hostname)) return url;
        u.searchParams.delete('dl');
        u.searchParams.set('raw', '1');
        u.hostname = 'dl.dropboxusercontent.com';
        return u.toString();
      } catch { return url; }
    }
    function normalizeSrc(src) {
      if (!src) return src;
      return src.includes('dropbox.com') ? toDropboxRaw(src) : src;
    }

    function showOverlay(msg) {
      const el = document.getElementById('overlay');
      el.textContent = msg;
      el.style.display = 'flex';
    }
    function hideOverlay() {
      document.getElementById('overlay').style.display = 'none';
    }

    async function loadManifest() {
      const res = await fetch(manifestUrl, { cache: 'no-store' });
      if (!res.ok) throw new Error('Manifest fetch failed');
      return res.json();
    }

    function buildViewerConfig(src, defaults = {}) {
      return {
        type: 'equirectangular',
        panorama: src,
        autoLoad: qs('autoLoad', 'true') !== 'false',
        showZoomCtrl: qs('zoomCtrl', 'true') !== 'false',
        showFullscreenCtrl: qs('fullscreenCtrl', 'true') !== 'false',
        compass: qs('compass', 'false') === 'true',
        pitch: num('pitch', defaults.pitch ?? 0),
        yaw: num('yaw', defaults.yaw ?? 0),
        hfov: num('hfov', defaults.hfov ?? 100)
      };
    }

    function startViewer(cfg, autorotate) {
      const viewer = pannellum.viewer('panorama', cfg);
      const ar = autorotate ?? null;
      if (ar !== null && ar !== undefined && ar !== '' && !Number.isNaN(Number(ar)) && Number(ar) !== 0) {
        viewer.startAutoRotate(Number(ar));
      }
      return viewer;
    }

    function showList(manifest) {
      const list = document.getElementById('list');
      list.style.display = 'block';
      const ids = Object.keys(manifest).sort();
      list.innerHTML = ids.length
        ? `<h2>Available 360 photos</h2>
           <p>Click to open. In Experience Builder, set your Embed URL to <code>?id={pano_id}</code> and store values like <code>360_100514</code> in your field.</p>
           <ul>${ids.map(id => {
             const t = manifest[id].title ? ` â€” ${manifest[id].title}` : '';
             return `<li><a href="?id=${encodeURIComponent(id)}">${id}</a>${t}</li>`;
           }).join('')}</ul>
           <p class="hint">Overrides: <code>pitch</code>, <code>yaw</code>, <code>hfov</code>, <code>autorotate</code>, <code>autoLoad</code>, <code>compass</code>.<br/>
           Example: <code>?id=360_100514&yaw=45&hfov=90&autorotate=2</code></p>`
        : '<h2>No entries in manifest.json</h2><p>Add items and reload.</p>';
    }

    async function main() {
      try {
        const id = qs('id');
        const srcParam = qs('src'); // Option to pass a direct URL

        if (!id && !srcParam) {
          const manifest = await loadManifest();
          showList(manifest);
          return;
        }

        let panoUrl = null;
        let defaults = {};
        if (srcParam) {
          panoUrl = normalizeSrc(decodeURIComponent(srcParam));
        } else {
          const manifest = await loadManifest();
          const item = manifest[id];
          if (!item) { showOverlay(`ID not found in manifest: ${id}`); return; }
          panoUrl = normalizeSrc(item.src || item.url);
          defaults = { yaw: item.yaw, pitch: item.pitch, hfov: item.hfov, autorotate: item.autorotate };
        }

        if (!panoUrl) { showOverlay('No panorama URL found.'); return; }

        const cfg = buildViewerConfig(panoUrl, defaults);
        const autorotate = qs('autorotate', (typeof defaults.autorotate !== 'undefined') ? String(defaults.autorotate) : null);
        startViewer(cfg, autorotate);
        hideOverlay();
      } catch (err) {
        console.error(err);
        showOverlay('There was an error loading the viewer. Check console for details.');
      }
    }

    main();
  </script>
</body>
</html>
